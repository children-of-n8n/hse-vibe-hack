# Backend Authoring Guide

Единые правила для разработки `apps/backend` на Elysia + Drizzle.

## Архитектура и расположение кода
- Доменные сущности: таблицы и репозитории в `src/domain/<entity>`.
- Бизнес-логика: `src/services`, без HTTP-деталей.
- HTTP-слой: `src/controllers/<feature>` — маршруты, контракты, макросы рядом.
- Плагины/инфраструктура: `src/http/plugins` (CORS, JWT, OpenAPI и т.д.).
- Точка входа: `src/index.ts`; миграции и подключение БД — `src/db`.

## Стиль и импорты
- Biome: 2 пробела, LF, двойные кавычки, точки с запятой, 80 колонок, сортировка импортов.
- Предпочтительны алиасы `@acme/backend/*` вместо глубоких `../../`.
- Код сервисов не должен напрямую зависеть от HTTP-контракта; протаскивайте данные через аргументы/DTO.

## Code Style для Elysia
- Маршруты группируйте по фичам в контроллерах: `new Elysia({ prefix: "/feature" })` + `.use(plugin)` + `.get/post(...)` + `.compile?.()` если нужно.
- Контракты/валидацию описывайте через схемы рядом с маршрутом; хэндлеры принимают уже валидированные данные.
- Ответы: возвращайте простые объекты или `Response`; не выбрасывайте строки ошибок — кидайте `Error` или используйте `set.status` и явный объект `{ message }`.
- Не храните состояние в инстансе Elysia; зависимостями делитесь через плагины или DI-фабрики.
- Именование роутов: пути — kebab-case, параметры через `:id`; функции-хэндлеры глагол+сущность (`getUser`, `createSession`).
- Ошибки/guards подключайте через middleware (`.derive`, `.guard`), не дублируйте проверки в каждом хэндлере.

## Тестирование
- Юниты пишем на `bun:test`; файлы `*.test.ts` рядом с кодом или в `tests/`.
- Для HTTP проверок используйте `app.handle(new Request(...))`, избегая реального сервера.
- Мокайте внешние вызовы (JWT, внешние API); без сетевого I/O в тестах.

## Миграции и данные
- Схемы и миграции в `src/db` (drizzle). При старте с `AUTO_MIGRATE=true` применяются только уже сгенерированные миграции из `src/db/migrations`.
- Новые поля: обновите таблицу в `src/domain/<entity>/table.ts`, затем вручную выполните `bun x drizzle-kit generate --config apps/backend/drizzle.config.ts` и `bun run --filter @acme/backend migrate`.
- Не коммитьте `.env`; по умолчанию SQLite, для других БД обновите `DATABASE_URL` в `.env`.

## Разработка и команды
- Установка: `bun install` в корне (скопирует `.env.example` → `.env`).
- Локальный запуск: `bun run --filter @acme/backend dev` (включает автопрогон миграций если не отключены).
- Проверки: `bun run --filter @acme/backend lint`, `tsc`, `bun test`.
- Форматирование: `bun run --filter @acme/backend format`.

## Контракты и безопасность
- Контракты/схемы валидируйте на входе контроллера; не полагайтесь на произвольные объекты в сервисах.
- JWT/CORS настройки держите в `src/http/plugins`; не расширяйте CORS без явной необходимости.
- Логику авторизации помещайте в middleware/guards, а не в контроллеры напрямую.

## Как добавлять фичу
1) Определите схему/репозиторий в `src/domain/<entity>`. 
2) Добавьте сервис с чистой бизнес-логикой. 
3) Опишите контракт + маршруты в `src/controllers/<feature>` и подключите в `src/index.ts`. 
4) Покройте сервисы/контроллеры тестами `bun:test`. 
5) Прогоните формат/линт/tsc перед коммитом.
